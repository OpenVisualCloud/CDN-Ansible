---
#
# Copyright 2017 Intel Corporation
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"),
# to deal in the Software without restriction, including without limitation
# the rights to use, copy, modify, merge, publish, distribute, sublicense,
# and/or sell copies of the Software, and to permit persons to whom
# the Software is furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
# DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
# TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH
# THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#
# Authour: Pushpendra Kumar (pushpendra.kumar@intel.com)
# Intel Corporation
#

# Installing the SVT dependencies for CentOS

#  - name: Add epel repository for CentOS
#    yum_repository:
#      name: epel
#      description: EPEL YUM repo
#      baseurl: http://dl.fedoraproject.org/pub/epel/$releasever/$basearch/
#      state: present
#      enabled: yes

  - name: Installing EPEL repository
    include: epel.yml

  - name: Installing SVT-HEVC Dependencies on CentOS
    become: yes
    become_user: root
    yum:
      name: "{{ packages }}"
      state: present
      update_cache: yes
    vars:
      packages:
      - epel-release
      - perl-ExtUtils-Embed
      - nasm
      - yasm
      - automake
      - autoconf
      - cmake
      - cmake3
      - libtool
      - git
      - gcc
      - gcc-c++
      - openssl-devel
      - libcurl-devel
      - unzip
      - curl
      - gmp-devel
      - mpfr-devel
      - libmpc-devel
      - pkgconfig
      - ca-certificates
      - bison
      - flex
      - patch
    register: dependencies
    until: dependencies is success
    retries: 2
    delay: 5


  - name: Enabling centos-release-scl repo 
    become: yes
    become_user: root
    yum:
      name: "{{ packages }}"
      state: present
      update_cache: yes
    vars:
      packages:
      - patch
      - centos-release-scl

  # Pause for 10 sec to build app cache
  - pause:
     seconds: 10

  - name: Installing devtoolset-7
    become: yes
    become_user: root
    yum:
      name: "{{ packages }}"
      state: present
      update_cache: yes
    vars:
      packages:
      - devtoolset-7-runtime
      - devtoolset-7
    register: devtoolset
    until: devtoolset is success
    retries: 5
    delay: 10

  - name: Enabling devtoolset-7
    shell: "source /opt/rh/devtoolset-7/enable"


  - name: Create the svt_sources dir
    become: yes
    file:
      path: "{{ item }}"
      state: directory
      owner: root
      mode: 0755
    with_items:
      - /opt/svt_sources
#      - /usr/local/build


  # Installing the cmake-3.13
  - name: Downloading cmake-3.13.1
    get_url:
      url: "{{ cmake_url }}"
      dest: "{{ svt_sources }}/cmake-3.13.1.tar.gz"
      validate_certs: false
    register: cmake_source

  - name: Unpacking cmake
    unarchive:
      dest: "{{ svt_sources }}"
      src: "{{ svt_sources }}/cmake-3.13.1.tar.gz"
      remote_src: yes

  - name: Compiling and installing cmake-3.13
    shell: "{{ item }}"
    args:
      chdir: "{{ svt_sources }}/cmake-3.13.1"
    with_items:
      - ./bootstrap --prefix="{{ svt_build_dir }}"
      - make -j$(nproc)
      - make -j$(nproc) install


  - name: Clone yasm from github
    git:
      repo: "{{ yasm_git_url }}"
      dest: "{{ svt_sources }}/yasm"
      force: yes
      accept_hostkey: yes

  - name: Compiling and installing yasm
    shell: "{{ item }}"
    args:
      chdir: "{{svt_sources}}/yasm"
    with_items:
      - autoreconf -fiv
      - ./configure --prefix={{ svt_build_dir }} 
      - make -j$(nproc)
      - make -j$(nproc) install


